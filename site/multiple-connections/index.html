<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://typeorm-legacy.productsway.com/multiple-connections/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Multiple connections, databases, schemas and replication setup - TypeORM 0.2.38</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Multiple connections, databases, schemas and replication setup";
        var mkdocs_page_input_path = "multiple-connections.md";
        var mkdocs_page_url = "/multiple-connections/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> TypeORM 0.2.38
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Documentation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../active-record-data-mapper/">Active Record vs Data Mapper</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching queries</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection-api/">Connection APIs</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection-options/">Connection Options</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection/">Working with Connection</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../custom-repository/">Custom repositories</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../decorator-reference/">Decorators reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../delete-query-builder/">Delete using Query Builder</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../eager-and-lazy-relations/">Eager and Lazy Relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../embedded-entities/">Embedded Entities</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../entities/">Entities</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../entity-inheritance/">Entity Inheritance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../entity-manager-api/">`EntityManager` API</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../entity-metadata/">Entity Metadata</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../example-with-express/">Example using TypeORM with Express</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">FAQ</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../find-options/">Find Options</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../indices/">Indices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../insert-query-builder/">Insert using Query Builder</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../internals/">Internals</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../listeners-and-subscribers/">Entity Listeners and Subscribers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../many-to-many-relations/">Many-to-many relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../many-to-one-one-to-many-relations/">Many-to-one / one-to-many relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../migrations/">Migrations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../mongodb/">MongoDB</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Multiple connections, databases, schemas and replication setup</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#using-multiple-connections">Using multiple connections</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-multiple-databases-in-a-single-connection">Using multiple databases in a single connection</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-multiple-schemas-in-a-single-connection">Using multiple schemas in a single connection</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#replication">Replication</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../naming-strategy/">Naming strategy</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../one-to-one-relations/">One-to-one relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../query-runner/">Working with Query Runner</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../relational-query-builder/">Working with Relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../relations-faq/">Relations FAQ</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../relations/">Relations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../repository-api/">Repository APIs</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../roadmap/">Roadmap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../select-query-builder/">Select using Query Builder</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../separating-entity-definition/">Separating Entity Definition</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sequelize-migration/">Migration from Sequelize to TypeORM</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../support/">Support</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported-platforms/">Supported platforms</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../transactions/">Transactions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tree-entities/">Tree Entities</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../update-query-builder/">Update using Query Builder</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../usage-with-javascript/">Using with JavaScript</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../using-cli/">Using CLI</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../using-ormconfig/">Using Configuration Sources</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../validation/">Using Validation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../view-entities/">View Entities</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../working-with-entity-manager/">What is EntityManager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../working-with-repository/">What is Repository</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">TypeORM 0.2.38</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>Multiple connections, databases, schemas and replication setup</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="multiple-connections-databases-schemas-and-replication-setup">Multiple connections, databases, schemas and replication setup</h1>
<ul>
<li><a href="#using-multiple-connections">Using multiple connections</a></li>
<li><a href="#using-multiple-databases-in-a-single-connection">Using multiple databases in a single connection</a></li>
<li><a href="#using-multiple-schemas-in-a-single-connection">Using multiple schemas in a single connection</a></li>
<li><a href="#replication">Replication</a></li>
</ul>
<h2 id="using-multiple-connections">Using multiple connections</h2>
<p>The simplest way to use multiple databases is to create different connections:</p>
<pre><code class="language-typescript">import {createConnections} from &quot;typeorm&quot;;

const connections = await createConnections([{
    name: &quot;db1Connection&quot;,
    type: &quot;mysql&quot;,
    host: &quot;localhost&quot;,
    port: 3306,
    username: &quot;root&quot;,
    password: &quot;admin&quot;,
    database: &quot;db1&quot;,
    entities: [__dirname + &quot;/entity/*{.js,.ts}&quot;],
    synchronize: true
}, {
    name: &quot;db2Connection&quot;,
    type: &quot;mysql&quot;,
    host: &quot;localhost&quot;,
    port: 3306,
    username: &quot;root&quot;,
    password: &quot;admin&quot;,
    database: &quot;db2&quot;,
    entities: [__dirname + &quot;/entity/*{.js,.ts}&quot;],
    synchronize: true
}]);
</code></pre>
<p>This approach allows you to connect to any number of databases you have 
and each database will have its own configuration, own entities and overall ORM scope and settings.</p>
<p>For each connection a new <code>Connection</code> instance will be created.
You must specify a unique name for each connection you create.</p>
<p>The connection options can also be loaded from an ormconfig file. You can load all connections from
the ormconfig file:</p>
<pre><code class="language-typescript">import {createConnections} from &quot;typeorm&quot;;

const connections = await createConnections();
</code></pre>
<p>or you can specify which connection to create by name:</p>
<pre><code class="language-typescript">import {createConnection} from &quot;typeorm&quot;;

const connection = await createConnection(&quot;db2Connection&quot;);
</code></pre>
<p>When working with connections you must specify a connection name to get a specific connection:</p>
<pre><code class="language-typescript">import {getConnection} from &quot;typeorm&quot;;

const db1Connection = getConnection(&quot;db1Connection&quot;);
// you can work with &quot;db1&quot; database now...

const db2Connection = getConnection(&quot;db2Connection&quot;);
// you can work with &quot;db2&quot; database now...
</code></pre>
<p>Benefit of using this approach is that you can configure multiple connections with different login credentials,
host, port and even database type itself.
Downside for might be that you'll need to manage and work with multiple connection instances. </p>
<h2 id="using-multiple-databases-in-a-single-connection">Using multiple databases in a single connection</h2>
<p>If you don't want to create multiple connections, 
but want to use multiple databases in a single connection,
you can specify database name per-entity you use:</p>
<pre><code class="language-typescript">import {Entity, PrimaryGeneratedColumn, Column} from &quot;typeorm&quot;;

@Entity({ database: &quot;secondDB&quot; })
export class User {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

}
</code></pre>
<pre><code class="language-typescript">import {Entity, PrimaryGeneratedColumn, Column} from &quot;typeorm&quot;;

@Entity({ database: &quot;thirdDB&quot; })
export class Photo {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    url: string;

}
</code></pre>
<p><code>User</code> entity will be created inside <code>secondDB</code> database and <code>Photo</code> entity inside <code>thirdDB</code> database.
All other entities will be created in default connection database.</p>
<p>If you want to select data from a different database you only need to provide an entity:</p>
<pre><code class="language-typescript">const users = await connection
    .createQueryBuilder()
    .select()
    .from(User, &quot;user&quot;)
    .addFrom(Photo, &quot;photo&quot;)
    .andWhere(&quot;photo.userId = user.id&quot;)
    .getMany(); // userId is not a foreign key since its cross-database request
</code></pre>
<p>This code will produce following sql query (depend on database type):</p>
<pre><code class="language-sql">SELECT * FROM &quot;secondDB&quot;.&quot;user&quot; &quot;user&quot;, &quot;thirdDB&quot;.&quot;photo&quot; &quot;photo&quot; 
    WHERE &quot;photo&quot;.&quot;userId&quot; = &quot;user&quot;.&quot;id&quot;
</code></pre>
<p>You can also specify a table path instead of the entity:</p>
<pre><code class="language-typescript">const users = await connection
    .createQueryBuilder()
    .select()
    .from(&quot;secondDB.user&quot;, &quot;user&quot;)
    .addFrom(&quot;thirdDB.photo&quot;, &quot;photo&quot;)
    .andWhere(&quot;photo.userId = user.id&quot;)
    .getMany(); // userId is not a foreign key since its cross-database request
</code></pre>
<p>This feature is supported only in mysql and mssql databases.</p>
<h2 id="using-multiple-schemas-in-a-single-connection">Using multiple schemas in a single connection</h2>
<p>You can use multiple schemas in your applications, just set <code>schema</code> on each entity:</p>
<pre><code class="language-typescript">import {Entity, PrimaryGeneratedColumn, Column} from &quot;typeorm&quot;;

@Entity({ schema: &quot;secondSchema&quot; })
export class User {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

}
</code></pre>
<pre><code class="language-typescript">import {Entity, PrimaryGeneratedColumn, Column} from &quot;typeorm&quot;;

@Entity({ schema: &quot;thirdSchema&quot; })
export class Photo {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    url: string;

}
</code></pre>
<p><code>User</code> entity will be created inside <code>secondSchema</code> schema and <code>Photo</code> entity inside <code>thirdSchema</code> schema.
All other entities will be created in default connection schema.</p>
<p>If you want to select data from a different schema you only need to provide an entity:</p>
<pre><code class="language-typescript">const users = await connection
    .createQueryBuilder()
    .select()
    .from(User, &quot;user&quot;)
    .addFrom(Photo, &quot;photo&quot;)
    .andWhere(&quot;photo.userId = user.id&quot;)
    .getMany(); // userId is not a foreign key since its cross-database request
</code></pre>
<p>This code will produce following sql query (depend on database type):</p>
<pre><code class="language-sql">SELECT * FROM &quot;secondSchema&quot;.&quot;question&quot; &quot;question&quot;, &quot;thirdSchema&quot;.&quot;photo&quot; &quot;photo&quot; 
    WHERE &quot;photo&quot;.&quot;userId&quot; = &quot;user&quot;.&quot;id&quot;
</code></pre>
<p>You can also specify a table path instead of the entity:</p>
<pre><code class="language-typescript">const users = await connection
    .createQueryBuilder()
    .select()
    .from(&quot;secondSchema.user&quot;, &quot;user&quot;) // in mssql you can even specify a database: secondDB.secondSchema.user
    .addFrom(&quot;thirdSchema.photo&quot;, &quot;photo&quot;) // in mssql you can even specify a database: thirdDB.thirdSchema.photo
    .andWhere(&quot;photo.userId = user.id&quot;)
    .getMany();
</code></pre>
<p>This feature is supported only in postgres and mssql databases.
In mssql you can also combine schemas and databases, for example:</p>
<pre><code class="language-typescript">import {Entity, PrimaryGeneratedColumn, Column} from &quot;typeorm&quot;;

@Entity({ database: &quot;secondDB&quot;, schema: &quot;public&quot; })
export class User {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

}
</code></pre>
<h2 id="replication">Replication</h2>
<p>You can setup read/write replication using TypeORM.
Example of replication connection settings:</p>
<pre><code class="language-typescript">{
  type: &quot;mysql&quot;,
  logging: true,
  replication: {
    master: {
      host: &quot;server1&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    },
    slaves: [{
      host: &quot;server2&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    }, {
      host: &quot;server3&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    }]
  }
}
</code></pre>
<p>All schema update and write operations are performed using <code>master</code> server.
All simple queries performed by find methods or select query builder are using a random <code>slave</code> instance.
All queries performed by query method are performed using the <code>master</code> instance.</p>
<p>If you want to explicitly use master in SELECT created by query builder, you can use the following code:</p>
<pre><code class="language-typescript">const masterQueryRunner = connection.createQueryRunner(&quot;master&quot;);
try {
    const postsFromMaster = await connection.createQueryBuilder(Post, &quot;post&quot;)
        .setQueryRunner(masterQueryRunner)
        .getMany();
} finally {
      await masterQueryRunner.release();
}

</code></pre>
<p>If you want to use <code>slave</code> in raw queries, you also need to explicitly specify the query runner.</p>
<pre><code class="language-typescript">
const slaveQueryRunner = connection.createQueryRunner(&quot;slave&quot;);
try {
    const userFromSlave = await slaveQueryRunner.query('SELECT * FROM users WHERE id = $1', [userId], slaveQueryRunner);
} finally {
    return slaveQueryRunner.release();
}
</code></pre>
<p>Note that connection created by a <code>QueryRunner</code> need to be explicitly released.</p>
<p>Replication is supported by mysql, postgres and sql server databases.</p>
<p>Mysql supports deep configuration:</p>
<pre><code class="language-typescript">{
  replication: {
    master: {
      host: &quot;server1&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    },
    slaves: [{
      host: &quot;server2&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    }, {
      host: &quot;server3&quot;,
      port: 3306,
      username: &quot;test&quot;,
      password: &quot;test&quot;,
      database: &quot;test&quot;
    }],

    /**
    * If true, PoolCluster will attempt to reconnect when connection fails. (Default: true)
    */
    canRetry: true,

    /**
     * If connection fails, node's errorCount increases.
     * When errorCount is greater than removeNodeErrorCount, remove a node in the PoolCluster. (Default: 5)
     */
    removeNodeErrorCount: 5,

    /**
     * If connection fails, specifies the number of milliseconds before another connection attempt will be made.
     * If set to 0, then node will be removed instead and never re-used. (Default: 0)
     */
     restoreNodeTimeout: 0,

    /**
     * Determines how slaves are selected:
     * RR: Select one alternately (Round-Robin).
     * RANDOM: Select the node by random function.
     * ORDER: Select the first node available unconditionally.
     */
    selector: &quot;RR&quot;
  }
}
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../mongodb/" class="btn btn-neutral float-left" title="MongoDB"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../naming-strategy/" class="btn btn-neutral float-right" title="Naming strategy">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../mongodb/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../naming-strategy/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
